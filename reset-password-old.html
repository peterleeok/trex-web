<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>비밀번호 재설정 | Trex.so</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
<style>
@import url('https://fonts.googleapis.com/css2?family=Pretendard:wght@300;400;600;700&display=swap');
body { font-family: 'Pretendard', sans-serif; }
.gradient-text {
background: linear-gradient(90deg, #3b82f6, #8b5cf6, #ec4899);
-webkit-background-clip: text;
-webkit-text-fill-color: transparent;
}
</style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-purple-50 min-h-screen flex items-center justify-center">

<div class="max-w-md w-full mx-4">
<!-- Logo -->
<div class="text-center mb-8">
<a href="index.html" class="inline-flex flex-col items-center group">
<img src="images/trex-logo.png" alt="Trex.so Logo" class="h-16 w-auto mb-2 transition-transform group-hover:scale-105">
<span class="text-2xl font-bold text-gray-800">Trex.so</span>
</a>
<p class="text-gray-600 mt-2">비밀번호를 잊으셨나요?</p>
</div>

<!-- Reset Card -->
<div class="bg-white rounded-2xl shadow-2xl p-8 border border-gray-100">
<div class="text-center mb-6">
<div class="w-16 h-16 bg-blue-100 rounded-full mx-auto flex items-center justify-center mb-4">
<i class="fa-solid fa-key text-blue-600 text-2xl"></i>
</div>
<h2 class="text-2xl font-bold text-gray-900 mb-2">비밀번호 재설정</h2>
<p class="text-gray-600 text-sm">가입하신 이메일로 임시 비밀번호를 보내드립니다</p>
</div>

<!-- Step 1: 이메일 입력 -->
<div id="step1">
<form id="resetForm" class="space-y-6">
<div>
<label class="block text-sm font-semibold text-gray-700 mb-2">
<i class="fa-solid fa-envelope mr-2"></i>이메일
</label>
<input type="email" id="resetEmail" placeholder="가입하신 이메일을 입력하세요" required
class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent transition">
</div>

<button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 rounded-full transition shadow-lg">
<i class="fa-solid fa-paper-plane mr-2"></i>재설정 링크 보내기
</button>
</form>
</div>

<!-- Step 2: 임시 비밀번호 입력 & 새 비밀번호 설정 -->
<div id="step2" class="hidden">
<form id="newPasswordForm" class="space-y-6">
<div>
<label class="block text-sm font-semibold text-gray-700 mb-2">
<i class="fa-solid fa-key mr-2"></i>임시 비밀번호
</label>
<input type="text" id="tempPassword" placeholder="이메일로 받은 임시 비밀번호 입력" required
class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent transition">
<p class="text-xs text-gray-500 mt-1">이메일로 전송된 6자리 임시 비밀번호를 입력하세요</p>
</div>

<div>
<label class="block text-sm font-semibold text-gray-700 mb-2">
<i class="fa-solid fa-lock mr-2"></i>새 비밀번호
</label>
<input type="password" id="newPassword" placeholder="새로운 비밀번호 (최소 6자)" required
class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent transition">
</div>

<div>
<label class="block text-sm font-semibold text-gray-700 mb-2">
<i class="fa-solid fa-lock mr-2"></i>새 비밀번호 확인
</label>
<input type="password" id="confirmPassword" placeholder="새 비밀번호 재입력" required
class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent transition">
</div>

<button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 rounded-full transition shadow-lg">
<i class="fa-solid fa-check mr-2"></i>비밀번호 변경 완료
</button>
</form>
</div>

<!-- 성공 메시지 -->
<div id="successMessage" class="hidden">
<div class="text-center py-6">
<div class="w-16 h-16 bg-green-100 rounded-full mx-auto flex items-center justify-center mb-4">
<i class="fa-solid fa-check-circle text-green-600 text-3xl"></i>
</div>
<h3 class="text-xl font-bold text-gray-900 mb-2">비밀번호가 변경되었습니다!</h3>
<p class="text-gray-600 mb-6">새 비밀번호로 로그인할 수 있습니다</p>
<a href="login.html" class="inline-block bg-blue-600 hover:bg-blue-700 text-white font-semibold px-6 py-3 rounded-full transition shadow-lg">
로그인 페이지로 이동
</a>
</div>
</div>

<!-- 오류/성공 메시지 -->
<div id="resetSuccess" class="hidden mt-4 p-4 bg-green-50 border border-green-200 rounded-xl text-green-700 text-sm">
<i class="fa-solid fa-check-circle mr-2"></i><span id="resetSuccessText">이메일로 임시 비밀번호를 보냈습니다!</span>
</div>
<div id="resetError" class="hidden mt-4 p-4 bg-red-50 border border-red-200 rounded-xl text-red-700 text-sm">
<i class="fa-solid fa-exclamation-circle mr-2"></i><span id="resetErrorText">오류가 발생했습니다.</span>
</div>

<!-- 링크 -->
<div class="mt-6 text-center text-sm">
<a href="login.html" class="text-blue-600 hover:text-blue-700 font-semibold">
<i class="fa-solid fa-arrow-left mr-1"></i>로그인으로 돌아가기
</a>
</div>
</div>

<!-- Info Box -->
<div class="mt-6 bg-white/80 backdrop-blur-sm rounded-xl p-4 border border-blue-200">
<p class="text-xs text-gray-600 text-center">
<i class="fa-solid fa-info-circle text-blue-500 mr-1"></i>
실제 이메일 발송 기능은 백엔드 서버가 필요합니다. 현재는 시뮬레이션 모드로 동작합니다.
</p>
</div>
</div>

<script>
// Step 1: 이메일 입력 → 임시 비밀번호 생성 및 전송 (시뮬레이션)
document.getElementById('resetForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const email = document.getElementById('resetEmail').value.trim();
    
    if (!email) {
        showError('이메일을 입력해주세요.');
        return;
    }

    try {
        // 1. 사용자 존재 여부 확인
        const response = await fetch(`tables/users?search=${encodeURIComponent(email)}&limit=10`);
        const result = await response.json();
        
        const user = result.data.find(u => u.email === email);
        
        if (!user) {
            showError('등록되지 않은 이메일입니다.');
            return;
        }

        // 2. 임시 비밀번호 생성 (6자리 랜덤)
        const tempPw = Math.random().toString(36).substring(2, 8).toUpperCase();
        
        // 3. 임시 비밀번호를 해시화하여 DB에 저장
        const hashedTempPw = await hashPassword(tempPw);
        
        const updateResponse = await fetch(`tables/users/${user.id}`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                password: hashedTempPw,
                temp_password: tempPw  // 시뮬레이션용 (실제론 이메일로 전송)
            })
        });

        if (!updateResponse.ok) throw new Error('임시 비밀번호 저장 실패');

        // 4. 성공 메시지 (실제로는 이메일 발송)
        showSuccess(`임시 비밀번호: <strong>${tempPw}</strong><br>이 비밀번호로 새 비밀번호를 설정하세요!`);
        
        // 5. Step 2로 이동
        setTimeout(() => {
            document.getElementById('step1').classList.add('hidden');
            document.getElementById('step2').classList.remove('hidden');
            document.getElementById('resetSuccess').classList.add('hidden');
        }, 3000);

        // 이메일 저장 (Step 2에서 사용)
        sessionStorage.setItem('resetEmail', email);

    } catch (error) {
        console.error('비밀번호 재설정 오류:', error);
        showError(error.message);
    }
});

// Step 2: 임시 비밀번호 확인 + 새 비밀번호 설정
document.getElementById('newPasswordForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const email = sessionStorage.getItem('resetEmail');
    const tempPassword = document.getElementById('tempPassword').value.trim();
    const newPassword = document.getElementById('newPassword').value;
    const confirmPassword = document.getElementById('confirmPassword').value;

    if (!tempPassword || !newPassword || !confirmPassword) {
        showError('모든 필드를 입력해주세요.');
        return;
    }

    if (newPassword.length < 6) {
        showError('새 비밀번호는 최소 6자 이상이어야 합니다.');
        return;
    }

    if (newPassword !== confirmPassword) {
        showError('새 비밀번호가 일치하지 않습니다.');
        return;
    }

    try {
        // 1. 사용자 조회
        const response = await fetch(`tables/users?search=${encodeURIComponent(email)}&limit=10`);
        const result = await response.json();
        const user = result.data.find(u => u.email === email);

        if (!user) {
            showError('사용자를 찾을 수 없습니다.');
            return;
        }

        // 2. 임시 비밀번호 확인
        if (user.temp_password !== tempPassword) {
            showError('임시 비밀번호가 일치하지 않습니다.');
            return;
        }

        // 3. 새 비밀번호 해시화 및 저장
        const hashedNewPw = await hashPassword(newPassword);
        
        const updateResponse = await fetch(`tables/users/${user.id}`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                password: hashedNewPw,
                temp_password: null  // 임시 비밀번호 제거
            })
        });

        if (!updateResponse.ok) throw new Error('비밀번호 변경 실패');

        // 4. 성공 화면 표시
        document.getElementById('step2').classList.add('hidden');
        document.getElementById('successMessage').classList.remove('hidden');
        document.getElementById('resetSuccess').classList.add('hidden');
        document.getElementById('resetError').classList.add('hidden');

        // 세션 정리
        sessionStorage.removeItem('resetEmail');

    } catch (error) {
        console.error('비밀번호 변경 오류:', error);
        showError(error.message);
    }
});

// SHA-256 해시 함수
async function hashPassword(password) {
    const encoder = new TextEncoder();
    const data = encoder.encode(password);
    const hashBuffer = await crypto.subtle.digest('SHA-256', data);
    const hashArray = Array.from(new Uint8Array(hashBuffer));
    return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
}

// 메시지 표시 함수
function showError(message) {
    document.getElementById('resetSuccess').classList.add('hidden');
    document.getElementById('resetError').classList.remove('hidden');
    document.getElementById('resetErrorText').textContent = message;
}

function showSuccess(message) {
    document.getElementById('resetError').classList.add('hidden');
    document.getElementById('resetSuccess').classList.remove('hidden');
    document.getElementById('resetSuccessText').innerHTML = message;
}
</script>

</body>
</html>