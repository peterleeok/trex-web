<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reset Password | Trex.so</title>
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    
    <!-- Google Fonts: Inter & Montserrat -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;900&family=Montserrat:wght@300;400;600;900&display=swap" rel="stylesheet">
    
    <!-- SpaceX Design System -->
    <link rel="stylesheet" href="css/spacex-design-system.css">
    
    <style>
        .step {
            display: none;
        }
        
        .step.active {
            display: block;
        }
        
        .step-indicator {
            transition: all 0.3s ease;
        }
        
        .step-indicator.completed {
            background: #00AEF0;
            color: #000000;
        }
        
        .step-indicator.active {
            border-color: #00AEF0;
            color: #00AEF0;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="spacex-nav">
        <div class="spacex-container">
            <div class="flex items-center justify-between">
                <!-- Logo -->
                <a href="index.html" class="flex items-center space-x-3">
                    <img src="images/trex-logo-full.png" alt="Trex.so - Travel. Assemble. Play." class="h-10 md:h-12 w-auto">
                    <span class="text-base font-bold tracking-tight">Trex.so</span>
                </a>
                
                <!-- Desktop Navigation -->
                <div class="hidden md:flex items-center space-x-8">
                    <a href="index.html" class="spacex-nav-link">홈</a>
                    <a href="market.html" class="spacex-nav-link">블록 마켓</a>
                </div>
                
                <!-- Login Button -->
                <div>
                    <a href="login.html" class="spacex-btn-secondary text-sm px-4 py-2">
                        <i class="fas fa-sign-in-alt mr-2"></i>로그인
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Reset Password Section -->
    <section class="pt-40 pb-20 min-h-screen">
        <div class="spacex-container">
            <div class="max-w-md mx-auto">
                <!-- Header -->
                <div class="text-center mb-8">
                    <div class="w-16 h-16 bg-[#00AEF0] rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-key text-lg text-black"></i>
                    </div>
                    <h1 class="text-xl font-bold mb-2">비밀번호 재설정</h1>
                    <p class="text-gray-400">이메일 인증을 통해 비밀번호를 재설정하세요</p>
                </div>
                
                <!-- Step Indicators -->
                <div class="flex items-center justify-center mb-8 space-x-4">
                    <div class="step-indicator active flex items-center justify-center w-10 h-10 rounded-full border-2 border-gray-800 font-bold" id="stepIndicator1">
                        1
                    </div>
                    <div class="w-12 h-0.5 bg-gray-800"></div>
                    <div class="step-indicator flex items-center justify-center w-10 h-10 rounded-full border-2 border-gray-800 font-bold" id="stepIndicator2">
                        2
                    </div>
                    <div class="w-12 h-0.5 bg-gray-800"></div>
                    <div class="step-indicator flex items-center justify-center w-10 h-10 rounded-full border-2 border-gray-800 font-bold" id="stepIndicator3">
                        3
                    </div>
                </div>
                
                <!-- Step 1: Email -->
                <div id="step1" class="step active spacex-card">
                    <h2 class="text-base font-bold mb-4 flex items-center">
                        <i class="fas fa-envelope mr-3 text-[#00AEF0]"></i>
                        1단계: 이메일 확인
                    </h2>
                    
                    <form id="emailForm" class="space-y-6">
                        <div>
                            <label class="block text-sm font-semibold text-gray-400 mb-2">
                                가입한 이메일 주소
                            </label>
                            <input type="email" 
                                   id="resetEmail" 
                                   required
                                   placeholder="your@email.com"
                                   class="w-full bg-[#121212] border border-gray-800 text-white px-4 py-3 rounded-sm focus:outline-none focus:border-[#00AEF0]">
                        </div>
                        
                        <button type="submit" class="spacex-btn-primary w-full">
                            <i class="fas fa-paper-plane mr-2"></i>인증 코드 전송
                        </button>
                    </form>
                    
                    <div class="mt-6 text-center">
                        <a href="login.html" class="text-sm text-gray-400 hover:text-[#00AEF0] transition-colors">
                            <i class="fas fa-arrow-left mr-2"></i>로그인으로 돌아가기
                        </a>
                    </div>
                </div>
                
                <!-- Step 2: Verification Code -->
                <div id="step2" class="step spacex-card">
                    <h2 class="text-base font-bold mb-4 flex items-center">
                        <i class="fas fa-shield-alt mr-3 text-[#00AEF0]"></i>
                        2단계: 인증 코드 입력
                    </h2>
                    
                    <p class="text-sm text-gray-400 mb-6">
                        <span id="sentEmail" class="text-[#00AEF0] font-semibold"></span>로<br>
                        인증 코드를 전송했습니다. 이메일을 확인해주세요.
                    </p>
                    
                    <form id="codeForm" class="space-y-6">
                        <div>
                            <label class="block text-sm font-semibold text-gray-400 mb-2">
                                6자리 인증 코드
                            </label>
                            <input type="text" 
                                   id="verificationCode" 
                                   required
                                   maxlength="6"
                                   placeholder="000000"
                                   class="w-full bg-[#121212] border border-gray-800 text-white text-lg font-mono text-center px-3 py-2 rounded-sm focus:outline-none focus:border-[#00AEF0] tracking-widest">
                        </div>
                        
                        <button type="submit" class="spacex-btn-primary w-full">
                            <i class="fas fa-check mr-2"></i>코드 확인
                        </button>
                    </form>
                    
                    <div class="mt-6 text-center">
                        <button onclick="resendCode()" class="text-sm text-gray-400 hover:text-[#00AEF0] transition-colors">
                            <i class="fas fa-redo mr-2"></i>코드 재전송
                        </button>
                    </div>
                </div>
                
                <!-- Step 3: New Password -->
                <div id="step3" class="step spacex-card">
                    <h2 class="text-base font-bold mb-4 flex items-center">
                        <i class="fas fa-lock mr-3 text-[#00AEF0]"></i>
                        3단계: 새 비밀번호 설정
                    </h2>
                    
                    <form id="passwordForm" class="space-y-6">
                        <div>
                            <label class="block text-sm font-semibold text-gray-400 mb-2">
                                새 비밀번호
                            </label>
                            <input type="password" 
                                   id="newPassword" 
                                   required
                                   minlength="6"
                                   placeholder="최소 6자 이상"
                                   class="w-full bg-[#121212] border border-gray-800 text-white px-4 py-3 rounded-sm focus:outline-none focus:border-[#00AEF0]">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-semibold text-gray-400 mb-2">
                                새 비밀번호 확인
                            </label>
                            <input type="password" 
                                   id="confirmPassword" 
                                   required
                                   minlength="6"
                                   placeholder="비밀번호를 다시 입력하세요"
                                   class="w-full bg-[#121212] border border-gray-800 text-white px-4 py-3 rounded-sm focus:outline-none focus:border-[#00AEF0]">
                        </div>
                        
                        <!-- Password Requirements -->
                        <div class="bg-[#121212] border border-gray-800 rounded-sm p-4">
                            <p class="text-sm font-semibold mb-2 text-gray-400">비밀번호 요구사항:</p>
                            <ul class="text-xs text-gray-500 space-y-1">
                                <li><i class="fas fa-check text-[#00AEF0] mr-2"></i>최소 6자 이상</li>
                                <li><i class="fas fa-check text-[#00AEF0] mr-2"></i>영문, 숫자, 특수문자 권장</li>
                            </ul>
                        </div>
                        
                        <button type="submit" class="spacex-btn-primary w-full">
                            <i class="fas fa-save mr-2"></i>비밀번호 재설정 완료
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="border-t border-gray-900 py-12">
        <div class="spacex-container text-center text-gray-500">
            <p class="mb-2">&copy; 2026 Trex.so. All rights reserved.</p>
            <p class="text-sm">Travel. Assemble. Play.</p>
        </div>
    </footer>

    <!-- Scripts -->
    <script>
        let currentStep = 1;
        let userEmail = '';
        let verificationToken = '';
        
        // Step 1: Email form submit
        document.getElementById('emailForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            userEmail = document.getElementById('resetEmail').value;
            
            // Check if email exists in users table
            try {
                const response = await fetch(`tables/users?search=${encodeURIComponent(userEmail)}`);
                const data = await response.json();
                
                const user = data.data.find(u => u.email === userEmail);
                
                if (!user) {
                    alert('등록되지 않은 이메일입니다.');
                    return;
                }
                
                // Generate verification code (6 digits)
                verificationToken = Math.floor(100000 + Math.random() * 900000).toString();
                
                // In a real app, send email with verification code
                console.log('Verification code:', verificationToken);
                alert(`인증 코드: ${verificationToken}\n(실제 앱에서는 이메일로 전송됩니다)`);
                
                // Move to step 2
                goToStep(2);
                
            } catch (error) {
                console.error('Error checking email:', error);
                alert('오류가 발생했습니다. 다시 시도해주세요.');
            }
        });
        
        // Step 2: Verification code form submit
        document.getElementById('codeForm').addEventListener('submit', (e) => {
            e.preventDefault();
            
            const code = document.getElementById('verificationCode').value;
            
            if (code !== verificationToken) {
                alert('인증 코드가 일치하지 않습니다.');
                return;
            }
            
            // Move to step 3
            goToStep(3);
        });
        
        // Step 3: Password form submit
        document.getElementById('passwordForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            if (newPassword !== confirmPassword) {
                alert('비밀번호가 일치하지 않습니다.');
                return;
            }
            
            if (newPassword.length < 6) {
                alert('비밀번호는 최소 6자 이상이어야 합니다.');
                return;
            }
            
            try {
                // Hash password
                const hashedPassword = await hashPassword(newPassword);
                
                // Find user and update password
                const response = await fetch(`tables/users?search=${encodeURIComponent(userEmail)}`);
                const data = await response.json();
                const user = data.data.find(u => u.email === userEmail);
                
                if (!user) {
                    alert('사용자를 찾을 수 없습니다.');
                    return;
                }
                
                // Update password
                await fetch(`tables/users/${user.id}`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        password: hashedPassword
                    })
                });
                
                alert('비밀번호가 성공적으로 재설정되었습니다!');
                window.location.href = 'login.html';
                
            } catch (error) {
                console.error('Error resetting password:', error);
                alert('비밀번호 재설정 중 오류가 발생했습니다.');
            }
        });
        
        // Go to step
        function goToStep(step) {
            // Hide all steps
            document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
            
            // Show target step
            document.getElementById(`step${step}`).classList.add('active');
            
            // Update indicators
            for (let i = 1; i <= 3; i++) {
                const indicator = document.getElementById(`stepIndicator${i}`);
                
                if (i < step) {
                    indicator.classList.add('completed');
                    indicator.classList.remove('active');
                } else if (i === step) {
                    indicator.classList.add('active');
                    indicator.classList.remove('completed');
                } else {
                    indicator.classList.remove('active', 'completed');
                }
            }
            
            // Update sent email display
            if (step === 2) {
                document.getElementById('sentEmail').textContent = userEmail;
            }
            
            currentStep = step;
        }
        
        // Resend code
        function resendCode() {
            verificationToken = Math.floor(100000 + Math.random() * 900000).toString();
            console.log('New verification code:', verificationToken);
            alert(`새로운 인증 코드: ${verificationToken}\n(실제 앱에서는 이메일로 전송됩니다)`);
        }
        
        // Hash password using SHA-256
        async function hashPassword(password) {
            const encoder = new TextEncoder();
            const data = encoder.encode(password);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            return hashHex;
        }
    </script>
</body>
</html>
