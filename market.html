<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Block Market | Trex.so - 여행 블록 마켓</title>
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    
    <!-- Google Fonts: Inter & Montserrat -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;900&family=Montserrat:wght@300;400;600;900&display=swap" rel="stylesheet">
    
    <!-- SpaceX Design System -->
    <link rel="stylesheet" href="css/spacex-design-system.css">
    
    <style>
        .category-btn.active {
            background: #00AEF0 !important;
            color: #000000 !important;
            border-color: #00AEF0 !important;
        }
        
        .block-card {
            transition: transform 0.2s ease, border-color 0.2s ease;
        }
        
        .block-card:hover {
            transform: translateY(-4px);
            border-color: #00AEF0;
        }
        
        .cart-badge {
            background: #00AEF0;
            color: #000000;
            font-weight: 700;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="spacex-nav">
        <div class="spacex-container">
            <div class="flex items-center justify-between">
                <!-- Logo -->
                <a href="index.html" class="flex items-center space-x-3">
                    <img src="images/trex-logo-full.png" alt="Trex.so - Travel. Assemble. Play." class="h-8 w-auto">
                    <span class="text-xl font-bold tracking-tight">Trex.so</span>
                </a>
                
                <!-- Desktop Navigation -->
                <div class="hidden md:flex items-center space-x-8">
                    <a href="index.html" class="spacex-nav-link">홈</a>
                    <a href="creator-studio.html" class="spacex-nav-link">크리에이터 스튜디오</a>
                    <a href="upload.html" class="spacex-nav-link">경험 업로드</a>
                    <a href="market.html" class="spacex-nav-link-active">블록 마켓</a>
                </div>
                
                <!-- Cart & Auth Buttons -->
                <div class="flex items-center space-x-4">
                    <!-- Cart Button -->
                    <button id="cartButton" class="relative p-2 hover:text-[#00AEF0] transition-colors">
                        <i class="fas fa-shopping-cart text-xl"></i>
                        <span id="cartCount" class="cart-badge absolute -top-1 -right-1 text-xs rounded-full w-5 h-5 flex items-center justify-center">0</span>
                    </button>
                    
                    <!-- Auth Buttons -->
                    <div id="authButtons">
                        <a href="login.html" class="spacex-btn-secondary text-sm px-4 py-2">로그인</a>
                    </div>
                    
                    <!-- Mobile Menu Toggle -->
                    <button id="mobileMenuBtn" class="md:hidden p-2">
                        <i class="fas fa-bars text-xl"></i>
                    </button>
                </div>
            </div>
            
            <!-- Mobile Menu -->
            <div id="mobileMenu" class="hidden md:hidden mt-4 pb-4 border-t border-gray-800 pt-4">
                <div class="flex flex-col space-y-3">
                    <a href="index.html" class="spacex-nav-link">홈</a>
                    <a href="creator-studio.html" class="spacex-nav-link">크리에이터 스튜디오</a>
                    <a href="upload.html" class="spacex-nav-link">경험 업로드</a>
                    <a href="market.html" class="spacex-nav-link-active">블록 마켓</a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Hero Section -->
    <section class="pt-40 pb-16">
        <div class="spacex-container text-center">
            <h1 class="spacex-headline mb-4">Travel Block Market</h1>
            <p class="spacex-body-large text-gray-400 max-w-2xl mx-auto">
                전 세계 크리에이터가 만든 독특한 여행 경험을 블록으로 구매하세요.<br>
                당신의 여정에 특별한 순간을 추가하세요.
            </p>
        </div>
    </section>

    <!-- Filter & Sort Section -->
    <section class="sticky top-[80px] bg-black/95 backdrop-blur-sm z-40 border-b border-gray-900 py-6 shadow-lg">
        <div class="spacex-container">
            <!-- Category Filters -->
            <div class="flex flex-wrap gap-3 mb-6">
                <button class="category-btn active spacex-btn-secondary text-sm px-4 py-2" data-category="all">
                    전체
                </button>
                <button class="category-btn spacex-btn-secondary text-sm px-4 py-2" data-category="식당">
                    <i class="fas fa-utensils mr-2"></i>식당
                </button>
                <button class="category-btn spacex-btn-secondary text-sm px-4 py-2" data-category="카페">
                    <i class="fas fa-coffee mr-2"></i>카페
                </button>
                <button class="category-btn spacex-btn-secondary text-sm px-4 py-2" data-category="K-뷰티">
                    <i class="fas fa-spa mr-2"></i>K-뷰티
                </button>
                <button class="category-btn spacex-btn-secondary text-sm px-4 py-2" data-category="관광지">
                    <i class="fas fa-landmark mr-2"></i>관광지
                </button>
                <button class="category-btn spacex-btn-secondary text-sm px-4 py-2" data-category="쇼핑">
                    <i class="fas fa-shopping-bag mr-2"></i>쇼핑
                </button>
            </div>
            
            <!-- Sort & Count -->
            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                <p class="text-gray-400">
                    총 <span id="blockCount" class="text-[#00AEF0] font-bold">0</span>개의 블록
                </p>
                
                <select id="sortSelect" class="bg-[#121212] border border-gray-800 text-white px-4 py-2 rounded focus:outline-none focus:border-[#00AEF0]">
                    <option value="popular">인기순</option>
                    <option value="rating">평점순</option>
                    <option value="price-low">가격 낮은순</option>
                    <option value="price-high">가격 높은순</option>
                </select>
            </div>
        </div>
    </section>

    <!-- Blocks Grid -->
    <section class="py-12">
        <div class="spacex-container">
            <div id="blocksGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                <!-- Blocks will be dynamically loaded here -->
            </div>
            
            <!-- Empty State -->
            <div id="emptyState" class="hidden text-center py-20">
                <i class="fas fa-box-open text-6xl text-gray-800 mb-4"></i>
                <h3 class="text-xl font-bold text-gray-400 mb-2">블록이 없습니다</h3>
                <p class="text-gray-500">다른 카테고리를 선택해보세요</p>
            </div>
        </div>
    </section>

    <!-- Cart Modal -->
    <div id="cartModal" class="fixed inset-0 bg-black/90 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-[#121212] border border-gray-800 rounded-sm max-w-2xl w-full max-h-[80vh] overflow-y-auto">
            <!-- Modal Header -->
            <div class="sticky top-0 bg-[#121212] border-b border-gray-800 p-6 flex items-center justify-between">
                <h2 class="text-2xl font-bold">장바구니</h2>
                <button id="closeCartBtn" class="text-gray-400 hover:text-white text-2xl">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <!-- Cart Items -->
            <div id="cartItems" class="p-6 space-y-4">
                <!-- Cart items will be dynamically loaded here -->
            </div>
            
            <!-- Cart Footer -->
            <div class="sticky bottom-0 bg-[#121212] border-t border-gray-800 p-6">
                <div class="flex items-center justify-between mb-4">
                    <span class="text-xl font-bold">총 금액</span>
                    <span id="cartTotal" class="text-2xl font-bold text-[#00AEF0]">$0.00</span>
                </div>
                <button id="checkoutBtn" class="spacex-btn-primary w-full">
                    구매하기
                </button>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="border-t border-gray-900 py-12 mt-20">
        <div class="spacex-container text-center text-gray-500">
            <p class="mb-2">&copy; 2026 Trex.so. All rights reserved.</p>
            <p class="text-sm">Travel. Assemble. Play.</p>
        </div>
    </footer>

    <!-- Scripts -->
    <script src="js/auth.js"></script>
    <script>
        // Initialize
        let allBlocks = [];
        let filteredBlocks = [];
        let currentCategory = 'all';
        let currentSort = 'popular';
        let cart = JSON.parse(localStorage.getItem('cart')) || [];
        
        // Update cart count on load
        updateCartCount();
        
        // Load blocks on page load
        document.addEventListener('DOMContentLoaded', async () => {
            await loadBlocks();
            updateAuthUI();
        });
        
        // Load blocks from API
        async function loadBlocks() {
            try {
                const response = await fetch('tables/blocks?limit=1000');
                const data = await response.json();
                
                // Filter only approved blocks
                allBlocks = data.data.filter(block => block.status === 'approved');
                filteredBlocks = [...allBlocks];
                
                updateBlockCount();
                sortAndRenderBlocks();
            } catch (error) {
                console.error('Error loading blocks:', error);
                showEmptyState();
            }
        }
        
        // Filter blocks by category
        function filterBlocks(category) {
            currentCategory = category;
            
            if (category === 'all') {
                filteredBlocks = [...allBlocks];
            } else {
                filteredBlocks = allBlocks.filter(block => block.category === category);
            }
            
            updateBlockCount();
            sortAndRenderBlocks();
        }
        
        // Sort and render blocks
        function sortAndRenderBlocks() {
            // Sort
            switch (currentSort) {
                case 'popular':
                    filteredBlocks.sort((a, b) => (b.purchases || 0) - (a.purchases || 0));
                    break;
                case 'rating':
                    filteredBlocks.sort((a, b) => (b.rating || 0) - (a.rating || 0));
                    break;
                case 'price-low':
                    filteredBlocks.sort((a, b) => (a.price || 0) - (b.price || 0));
                    break;
                case 'price-high':
                    filteredBlocks.sort((a, b) => (b.price || 0) - (a.price || 0));
                    break;
            }
            
            renderBlocks();
        }
        
        // Render blocks
        function renderBlocks() {
            const grid = document.getElementById('blocksGrid');
            const emptyState = document.getElementById('emptyState');
            
            if (filteredBlocks.length === 0) {
                grid.innerHTML = '';
                emptyState.classList.remove('hidden');
                return;
            }
            
            emptyState.classList.add('hidden');
            
            grid.innerHTML = filteredBlocks.map(block => `
                <div class="spacex-card block-card group">
                    <!-- Image -->
                    <div class="relative h-48 bg-[#000] overflow-hidden mb-4">
                        ${block.images && block.images.length > 0 ? `
                            <img src="${block.images[0]}" alt="${block.title}" 
                                 class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300">
                        ` : `
                            <div class="w-full h-full flex items-center justify-center">
                                <i class="fas fa-image text-4xl text-gray-800"></i>
                            </div>
                        `}
                        
                        <!-- Category Badge -->
                        <div class="absolute top-3 left-3 bg-black/80 text-white text-xs px-3 py-1 rounded-sm">
                            ${block.category || '기타'}
                        </div>
                    </div>
                    
                    <!-- Content -->
                    <div class="space-y-3">
                        <!-- Title -->
                        <h3 class="text-lg font-bold line-clamp-2 group-hover:text-[#00AEF0] transition-colors">
                            ${block.title}
                        </h3>
                        
                        <!-- Location -->
                        <p class="text-sm text-gray-400 flex items-center">
                            <i class="fas fa-map-marker-alt mr-2 text-[#00AEF0]"></i>
                            ${block.location || 'Seoul, Korea'}
                        </p>
                        
                        <!-- Rating & Purchases -->
                        <div class="flex items-center justify-between text-sm">
                            <div class="flex items-center space-x-3">
                                <span class="text-yellow-400">
                                    <i class="fas fa-star mr-1"></i>
                                    ${(block.rating || 4.5).toFixed(1)}
                                </span>
                                <span class="text-gray-500">
                                    ${block.purchases || 0}명 구매
                                </span>
                            </div>
                        </div>
                        
                        <!-- Price & Add to Cart -->
                        <div class="flex items-center justify-between pt-3 border-t border-gray-800">
                            <span class="text-xl font-bold text-[#00AEF0]">
                                $${(block.price || 0.99).toFixed(2)}
                            </span>
                            <button onclick="addToCart('${block.id}')" 
                                    class="spacex-btn-secondary text-sm px-4 py-2 hover:bg-[#00AEF0] hover:text-black hover:border-[#00AEF0] transition-colors">
                                <i class="fas fa-cart-plus mr-2"></i>담기
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        // Add to cart
        function addToCart(blockId) {
            const block = allBlocks.find(b => b.id === blockId);
            if (!block) return;
            
            const existingItem = cart.find(item => item.id === blockId);
            
            if (existingItem) {
                alert('이미 장바구니에 있는 블록입니다.');
                return;
            }
            
            cart.push({
                id: block.id,
                title: block.title,
                price: block.price || 0.99,
                image: block.images && block.images.length > 0 ? block.images[0] : '',
                category: block.category || '기타'
            });
            
            localStorage.setItem('cart', JSON.stringify(cart));
            updateCartCount();
            
            // Show feedback
            alert('장바구니에 추가되었습니다!');
        }
        
        // Update cart count
        function updateCartCount() {
            const count = cart.length;
            document.getElementById('cartCount').textContent = count;
            document.getElementById('cartCount').classList.toggle('hidden', count === 0);
        }
        
        // Update block count
        function updateBlockCount() {
            document.getElementById('blockCount').textContent = filteredBlocks.length;
        }
        
        // Show empty state
        function showEmptyState() {
            document.getElementById('blocksGrid').innerHTML = '';
            document.getElementById('emptyState').classList.remove('hidden');
            document.getElementById('blockCount').textContent = '0';
        }
        
        // Render cart
        function renderCart() {
            const cartItems = document.getElementById('cartItems');
            const cartTotal = document.getElementById('cartTotal');
            
            if (cart.length === 0) {
                cartItems.innerHTML = `
                    <div class="text-center py-12">
                        <i class="fas fa-shopping-cart text-5xl text-gray-800 mb-4"></i>
                        <p class="text-gray-400">장바구니가 비어있습니다</p>
                    </div>
                `;
                cartTotal.textContent = '$0.00';
                return;
            }
            
            const total = cart.reduce((sum, item) => sum + item.price, 0);
            
            cartItems.innerHTML = cart.map((item, index) => `
                <div class="flex items-center gap-4 p-4 bg-black border border-gray-800 rounded-sm">
                    <!-- Image -->
                    <div class="w-20 h-20 bg-[#121212] flex-shrink-0 overflow-hidden">
                        ${item.image ? `
                            <img src="${item.image}" alt="${item.title}" class="w-full h-full object-cover">
                        ` : `
                            <div class="w-full h-full flex items-center justify-center">
                                <i class="fas fa-image text-2xl text-gray-800"></i>
                            </div>
                        `}
                    </div>
                    
                    <!-- Info -->
                    <div class="flex-1">
                        <h4 class="font-bold mb-1">${item.title}</h4>
                        <p class="text-sm text-gray-400">${item.category}</p>
                        <p class="text-[#00AEF0] font-bold mt-2">$${item.price.toFixed(2)}</p>
                    </div>
                    
                    <!-- Remove Button -->
                    <button onclick="removeFromCart(${index})" 
                            class="text-gray-400 hover:text-red-500 transition-colors">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `).join('');
            
            cartTotal.textContent = `$${total.toFixed(2)}`;
        }
        
        // Remove from cart
        function removeFromCart(index) {
            cart.splice(index, 1);
            localStorage.setItem('cart', JSON.stringify(cart));
            updateCartCount();
            renderCart();
        }
        
        // Checkout
        function checkout() {
            if (cart.length === 0) {
                alert('장바구니가 비어있습니다.');
                return;
            }
            
            // Check if user is logged in
            const user = JSON.parse(localStorage.getItem('user') || 'null');
            
            if (!user) {
                alert('로그인이 필요합니다.');
                window.location.href = 'login.html';
                return;
            }
            
            // In a real application, this would process payment
            alert(`구매가 완료되었습니다!\n총 ${cart.length}개 블록 - $${cart.reduce((sum, item) => sum + item.price, 0).toFixed(2)}`);
            
            // Clear cart
            cart = [];
            localStorage.setItem('cart', JSON.stringify(cart));
            updateCartCount();
            renderCart();
            document.getElementById('cartModal').classList.add('hidden');
        }
        
        // Category button click handlers
        document.querySelectorAll('.category-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                // Update active state
                document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                
                // Filter blocks
                const category = btn.dataset.category;
                filterBlocks(category);
            });
        });
        
        // Sort select change handler
        document.getElementById('sortSelect').addEventListener('change', (e) => {
            currentSort = e.target.value;
            sortAndRenderBlocks();
        });
        
        // Cart button click handler
        document.getElementById('cartButton').addEventListener('click', () => {
            document.getElementById('cartModal').classList.remove('hidden');
            renderCart();
        });
        
        // Close cart button click handler
        document.getElementById('closeCartBtn').addEventListener('click', () => {
            document.getElementById('cartModal').classList.add('hidden');
        });
        
        // Checkout button click handler
        document.getElementById('checkoutBtn').addEventListener('click', checkout);
        
        // Close cart modal when clicking outside
        document.getElementById('cartModal').addEventListener('click', (e) => {
            if (e.target.id === 'cartModal') {
                document.getElementById('cartModal').classList.add('hidden');
            }
        });
        
        // Mobile menu toggle
        document.getElementById('mobileMenuBtn').addEventListener('click', () => {
            const menu = document.getElementById('mobileMenu');
            const icon = document.querySelector('#mobileMenuBtn i');
            
            menu.classList.toggle('hidden');
            icon.classList.toggle('fa-bars');
            icon.classList.toggle('fa-times');
        });
        
        // Update auth UI
        function updateAuthUI() {
            const user = JSON.parse(localStorage.getItem('user') || 'null');
            const authButtons = document.getElementById('authButtons');
            
            if (user) {
                authButtons.innerHTML = `
                    <div class="flex items-center space-x-4">
                        <a href="profile.html" class="spacex-nav-link flex items-center">
                            <i class="fas fa-user-circle mr-2"></i>
                            ${user.name}
                        </a>
                        <button onclick="logout()" class="spacex-btn-secondary text-sm px-4 py-2">
                            로그아웃
                        </button>
                    </div>
                `;
            } else {
                authButtons.innerHTML = `
                    <a href="login.html" class="spacex-btn-secondary text-sm px-4 py-2">로그인</a>
                `;
            }
        }
        
        // Logout
        function logout() {
            localStorage.removeItem('user');
            window.location.href = 'index.html';
        }
    </script>
</body>
</html>
